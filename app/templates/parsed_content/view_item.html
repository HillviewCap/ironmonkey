{% extends "base.html" %}

{% block scripts %}
<!-- Remove or comment out the inclusion of parsed_content.js -->
<!-- <script src="{{ url_for('static', filename='js/parsed_content.js') }}"></script> -->
{% endblock %}

{% block content %}
<div class="container mx-auto mt-8">
    <h1 class="text-3xl font-bold mb-4">{{ item.title }}</h1>
    
    {% if item.creator %}
    <p class="text-gray-700 mb-2">Author(s): {{ item.creator }}</p>
    {% endif %}
    
    <p class="text-gray-600 mb-2">
        Date Published: 
        {% if item.pub_date %}
            {{ item.pub_date.strftime('%Y-%m-%d %H:%M:%S UTC') if item.pub_date is not string else item.pub_date }}
        {% else %}
            N/A
        {% endif %}
    </p>
    
    {% if item.url %}
    <p class="text-gray-600 mb-4">
        URL: <a href="{{ item.url }}" target="_blank" class="text-blue-500 hover:text-blue-700">{{ item.url }}</a>
    </p>
    {% endif %}
    
    {% if item.categories %}
    <div class="mb-4">
        <h2 class="text-xl font-semibold mb-2">Categories</h2>
        <div class="flex flex-wrap gap-2">
            {% for category in item.categories %}
                <a href="{{ url_for('search.search', query=category.name) }}" class="bg-gray-200 hover:bg-gray-300 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 transition duration-300">{{ category.name }}</a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% if item.description %}
    {% if item.description %}
    <div class="mb-6">
        <h2 class="text-xl font-semibold mb-2">Description</h2>
        <div id="item-description">
            {{ item.description | safe }}
        </div>
    </div>
    {% endif %}
    {% endif %}
    
    {% if item.summary %}
    <div class="mb-6">
        <h2 class="text-xl font-semibold mb-2">Summary</h2>
        {% set summary_data = item.summary | from_json %}
        {% if summary_data %}
            <h3 class="text-lg font-semibold mt-2">Main Topic</h3>
            <p>{{ summary_data.main_topic | safe }}</p>
            
            <h3 class="text-lg font-semibold mt-2">Key Points</h3>
            <ul class="list-disc pl-5">
                {% for point in summary_data.key_points %}
                    <li>{{ point | safe }}</li>
                {% endfor %}
            </ul>
            
            {% if summary_data.threat_actors %}
                <h3 class="text-lg font-semibold mt-2">Threat Actors</h3>
                <ul class="list-disc pl-5">
                    {% for actor in summary_data.threat_actors %}
                        <li>{{ actor | safe }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            
            {% if summary_data.ttps %}
                <h3 class="text-lg font-semibold mt-2">TTPs</h3>
                <ul class="list-disc pl-5">
                    {% for ttp in summary_data.ttps %}
                        <li>{{ ttp | safe }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            
            {% if summary_data.iocs %}
                <h3 class="text-lg font-semibold mt-2">IoCs</h3>
                <ul class="list-disc pl-5">
                    {% for ioc in summary_data.iocs %}
                        <li>{{ ioc | safe }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            
            {% if summary_data.affected_systems %}
                <h3 class="text-lg font-semibold mt-2">Affected Systems</h3>
                <ul class="list-disc pl-5">
                    {% for system in summary_data.affected_systems %}
                        <li>{{ system | safe }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            
            {% if summary_data.mitigations %}
                <h3 class="text-lg font-semibold mt-2">Mitigations</h3>
                <ul class="list-disc pl-5">
                    {% for mitigation in summary_data.mitigations %}
                        <li>{{ mitigation | safe }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            
            {% if summary_data.conclusion %}
                <h3 class="text-lg font-semibold mt-2">Conclusion</h3>
                <p>{{ summary_data.conclusion | safe }}</p>
            {% endif %}
        {% else %}
            <p>{{ item.summary | safe }}</p>
        {% endif %}
    </div>
    {% endif %}
    
    {% if item.link %}
    <a href="{{ item.link }}" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded inline-block">
        View Original Article
    </a>
    {% endif %}
</div>

{% include "components/entity_modal.html" %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const description = document.getElementById('item-description');
    if (description) {
        description.innerHTML = description.innerHTML.replace(
            /<span class="tagged-entity" data-entity-type="([^"]*)" data-entity-id="([^"]*)">([^<]*)<\/span>/g,
            function(match, entityType, entityId, entityName) {
                let detailPageUrl = '';
                if (entityType === 'actor') {
                    detailPageUrl = `/apt/group/${entityId}`;
                } else if (entityType === 'tool') {
                    detailPageUrl = `/apt/tool/${entityId}`;
                }
                return `<a href="${detailPageUrl}" class="tagged-entity text-blue-500 hover:underline" data-entity-type="${entityType}" data-entity-id="${entityId}">${entityName}</a>`;
            }
        );
    }
});
</script>

{% endblock %}
