{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">Blog Posts</h1>
    
    <div class="mb-6 flex justify-end">
        <button id="export-csv-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-300">Export to CSV</button>
    </div>

    <div id="parsed-content-table" class="bg-white shadow-md rounded-lg overflow-hidden"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const container = document.getElementById('parsed-content-table');
            const grid = new gridjs.Grid({
                columns: [
                    {
                        name: 'ID',
                        hidden: true
                    },
                    {
                        name: 'Title',
                        formatter: (cell, row) => gridjs.html(`<a href="/content/item/${row.cells[0].data}" class="text-blue-600 hover:underline">${cell}</a>`)
                    },
                    'Description',
                    'Published Date',
                    {
                        name: 'Actions',
                        formatter: (_, row) => gridjs.html(`<button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" onclick="summarizeContent('${row.cells[0].data}')">Summarize</button>`)
                    }
                ],
                server: {
                    url: parsedContentUrl,
                    then: data => data.data,
                    total: data => data.total
                },
                pagination: {
                    limit: 10,
                    server: {
                        url: (prev, page, limit) => `${prev}${prev.includes('?') ? '&' : '?'}limit=${limit}&page=${page}`
                    }
                },
                search: {
                    server: {
                        url: (prev, keyword) => `${prev}${prev.includes('?') ? '&' : '?'}search=${keyword}`
                    }
                },
                sort: true,
                className: {
                    table: 'w-full',
                    th: 'bg-gray-100 border-b p-2',
                    td: 'border-b p-2'
                }
            }).render(document.getElementById('parsed-content-table'));
        });
        document.getElementById('export-csv-btn').addEventListener('click', function () {
            const searchParams = new URLSearchParams(window.location.search);
            const search = searchParams.get('search') || '';
            const feed_id = searchParams.get('feed_id') || '';
            const url = `${exportCsvUrl}?search=${search}&feed_id=${feed_id}`;
            window.location.href = url;
        });
        const exportCsvUrl = "{{ url_for('parsed_content.export_csv') }}";
    </script>

    <script src="{{ url_for('static', filename='js/node_modules/gridjs/dist/gridjs.umd.js') }}"></script>
    <link href="{{ url_for('static', filename='js/node_modules/gridjs/dist/theme/mermaid.min.css') }}" rel="stylesheet" />

    <script>
        const parsedContentUrl = "{{ url_for('parsed_content.get_parsed_content') }}";
        const summarizeContentUrl = "{{ url_for('parsed_content.summarize_content') }}";
        const csrfToken = "{{ csrf_token() }}";
    </script>
    <script src="{{ url_for('static', filename='js/parsed_content.js') }}"></script>
</div>
{% endblock %}
