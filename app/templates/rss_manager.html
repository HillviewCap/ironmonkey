{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">RSS Feed Manager</h1>

    <!-- Existing Feeds Section -->
    <div class="mb-8 p-6 bg-white shadow-md rounded-lg">
        <h2 class="text-xl font-bold mb-4">Existing Feeds</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="py-2 px-4 border-b">URL</th>
                        <th class="py-2 px-4 border-b">Category</th>
                        <th class="py-2 px-4 border-b">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for feed in feeds %}
                    <tr>
                        <td class="py-2 px-4 border-b">{{ feed.url }}</td>
                        <td class="py-2 px-4 border-b">{{ feed.category }}</td>
                        <td class="py-2 px-4 border-b">
                            <a href="{{ url_for('rss_manager.edit_feed', feed_id=feed.id) }}" class="text-blue-500 hover:text-blue-700" title="Edit this feed">Edit</a>
                            <form action="{{ url_for('rss_manager.delete_rss_feed', feed_id=feed.id) }}" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to delete this feed?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="text-red-500 hover:text-red-700 ml-2">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Single Feed and Import Feeds from CSV Forms -->
    <div class="flex space-x-4 mb-8">
        <!-- Add Single Feed Form -->
        <div class="flex-1 p-6 bg-white shadow-md rounded-lg">
            <h2 class="text-xl font-bold mb-4">Add Single Feed</h2>
            <form id="addSingleFeedForm" onsubmit="return addFeed(event);">
                {{ form.hidden_tag() }}
                <div class="mb-4">
                    {{ form.url.label(class="block text-gray-700 text-sm font-bold mb-2") }}
                    {{ form.url(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline") }}
                </div>
                <div class="mb-4">
                    {{ form.category.label(class="block text-gray-700 text-sm font-bold mb-2") }}
                    {{ form.category(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline") }}
                </div>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Add Feed
                </button>
            </form>
        </div>

        <!-- Import Feeds from CSV Form -->
        <div class="flex-1 p-6 bg-white shadow-md rounded-lg">
            <h2 class="text-xl font-bold mb-4">Import Feeds from CSV</h2>
            <form method="POST" enctype="multipart/form-data">
                {{ csv_form.hidden_tag() }}
                <div class="mb-4">
                    {{ csv_form.file.label(class="block text-gray-700 text-sm font-bold mb-2") }}
                    {{ csv_form.file(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline") }}
                </div>
                {{ csv_form.submit(class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline") }}
            </form>
            <div class="mt-4">
                <a href="{{ url_for('static', filename='import_template.csv') }}" class="text-blue-500 hover:text-blue-700">
                    Download CSV Template
                </a>
            </div>
        </div>
    </div>

    <h2 class="text-2xl font-bold mb-4">Awesome Threat Intel Blogs</h2>
    <div class="mb-4 flex space-x-4">
        <form action="{{ url_for('rss_manager.update_awesome_threat_intel') }}" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to update Awesome Threat Intel Blogs?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">
                Update Awesome Threat Intel Blogs
            </button>
        </form>
    </div>
    <div id="awesomeBlogsContainer" class="p-6 bg-white shadow-md rounded-lg">
        <div id="awesomeBlogsGrid"></div>
    </div>

    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <script>
        async function addFeed(event) {
            event.preventDefault();
            const form = document.getElementById('addSingleFeedForm');
            const formData = new FormData(form);
            const response = await fetch('{{ url_for("rss_manager.create_rss_feed") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(Object.fromEntries(formData))
            });
            const result = await response.json();
            if (response.ok) {
                showNotification('Feed added successfully', 'success');
                form.reset();
                grid.forceRender();
            } else {
                showNotification('Error adding feed: ' + result.error, 'error');
            }
        }

        async function addAwesomeFeed(blogId) {
            try {
                const response = await fetch('{{ url_for("rss_manager.add_awesome_feed") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ blog_id: blogId })
                });

                const result = await response.json();

                if (response.ok) {
                    if (response.status === 200) {
                        showNotification('Awesome feed added and parsed successfully', 'success');
                        console.log('Parsed content:', result.parsed_content);
                        // You can update the UI here with the parsed content if needed
                    } else if (response.status === 202) {
                        showNotification('Awesome feed added successfully, but parsing failed', 'warning');
                        console.error('Parse error:', result.parse_error);
                    }
                    grid.forceRender();
                } else {
                    showNotification('Error adding awesome feed: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error adding awesome feed:', error);
                showNotification('An unexpected error occurred while adding the awesome feed', 'error');
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.className = `fixed top-4 right-4 p-4 rounded-md ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const grid = new gridjs.Grid({
                columns: [
                    { id: 'blog', name: 'Blog' },
                    { id: 'blog_category', name: 'Category' },
                    { id: 'type', name: 'Type' },
                    { 
                        id: 'blog_link', 
                        name: 'Blog Link',
                        formatter: (cell) => gridjs.html(`<a href="${cell}" target="_blank" class="text-blue-500 hover:text-blue-700">Blog Link</a>`)
                    },
                    { 
                        id: 'feed_link', 
                        name: 'Feed Link',
                        formatter: (cell) => cell ? gridjs.html(`<a href="${cell}" target="_blank" class="text-blue-500 hover:text-blue-700">Feed Link</a>`) : 'No RSS feed available'
                    },
                    {
                        id: 'actions',
                        name: 'Actions',
                        formatter: (_, row) => {
                            const feedLink = row.cells[4].data;
                            const isInRssFeeds = row.cells[7].data;
                            if (feedLink && !isInRssFeeds) {
                                return gridjs.html(`<button onclick="addAwesomeFeed('${row.cells[6].data}')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline add-feed-btn">Add Feed</button>`);
                            } else if (isInRssFeeds) {
                                return gridjs.html('<p class="text-sm text-green-500 font-bold">Already in RSS Feeds</p>');
                            }
                            return '';
                        }
                    },
                    { id: 'id', name: 'ID', hidden: true },
                    { id: 'is_in_rss_feeds', name: 'Is In RSS Feeds', hidden: true }
                ],
                server: {
                    url: '{{ url_for("rss_manager.get_awesome_blogs") }}',
                    then: response => response.data.map(blog => [
                        blog.blog,
                        blog.blog_category,
                        blog.type,
                        blog.blog_link,
                        blog.feed_link,
                        blog.id,
                        blog.is_in_rss_feeds
                    ])
                },
                search: true,
                sort: true,
                pagination: true,
                className: {
                    table: 'min-w-full bg-white'
                }
            }).render(document.getElementById("awesomeBlogsGrid"));

        });
    </script>
{% endblock %}
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.className = `fixed top-4 right-4 p-4 rounded-md ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        async function addAwesomeFeed(blogId) {
            try {
                // Ensure the blogId is a valid UUID string
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                if (!uuidRegex.test(blogId)) {
                    showNotification('Invalid blog ID format', 'error');
                    return;
                }

                const response = await fetch('{{ url_for("rss_manager.add_awesome_feed") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ blog_id: blogId })
                });

                const result = await response.json();

                if (response.ok) {
                    if (response.status === 200) {
                        showNotification('Awesome feed added and parsed successfully', 'success');
                        console.log('Parsed content:', result.parsed_content);
                        // You can update the UI here with the parsed content if needed
                    } else if (response.status === 202) {
                        showNotification('Awesome feed added successfully, but parsing failed', 'warning');
                        console.error('Parse error:', result.parse_error);
                    }
                    grid.forceRender();
                } else {
                    showNotification('Error adding awesome feed: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error adding awesome feed:', error);
                showNotification('An unexpected error occurred while adding the awesome feed', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const grid = new gridjs.Grid({
                columns: [
                    { id: 'blog', name: 'Blog' },
                    { id: 'blog_category', name: 'Category' },
                    { id: 'type', name: 'Type' },
                    { 
                        id: 'blog_link', 
                        name: 'Blog Link',
                        formatter: (cell) => gridjs.html(`<a href="${cell}" target="_blank" class="text-blue-500 hover:text-blue-700">Blog Link</a>`)
                    },
                    { 
                        id: 'feed_link', 
                        name: 'Feed Link',
                        formatter: (cell) => cell ? gridjs.html(`<a href="${cell}" target="_blank" class="text-blue-500 hover:text-blue-700">Feed Link</a>`) : 'No RSS feed available'
                    },
                    {
                        id: 'actions',
                        name: 'Actions',
                        formatter: (_, row) => {
                            const feedLink = row.cells[4].data;
                            const isInRssFeeds = row.cells[7].data;
                            const blogId = row.cells[6].data;
                            if (feedLink && !isInRssFeeds) {
                                return gridjs.html(`<button onclick="addAwesomeFeed('${blogId}')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline add-feed-btn">Add Feed</button>`);
                            } else if (isInRssFeeds) {
                                return gridjs.html('<p class="text-sm text-green-500 font-bold">Already in RSS Feeds</p>');
                            }
                            return '';
                        }
                    },
                    { id: 'id', name: 'ID', hidden: true },
                    { id: 'is_in_rss_feeds', name: 'Is In RSS Feeds', hidden: true }
                ],
                server: {
                    url: '{{ url_for("rss_manager.get_awesome_blogs") }}',
                    then: response => response.data
                },
                search: true,
                sort: true,
                pagination: true,
                className: {
                    table: 'min-w-full bg-white'
                }
            }).render(document.getElementById("awesomeBlogsGrid"));
        });
    </script>
