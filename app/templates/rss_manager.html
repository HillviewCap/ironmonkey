{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">RSS Feed Manager</h1>

    <!-- Existing Feeds Section -->
    <div class="mb-8 p-6 bg-white shadow-md rounded-lg">
        <h2 class="text-xl font-bold mb-4">Existing Feeds</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="py-2 px-4 border-b">URL</th>
                        <th class="py-2 px-4 border-b">Category</th>
                        <th class="py-2 px-4 border-b">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for feed in feeds %}
                    <tr>
                        <td class="py-2 px-4 border-b">{{ feed.url }}</td>
                        <td class="py-2 px-4 border-b">{{ feed.category }}</td>
                        <td class="py-2 px-4 border-b">
                            <a href="{{ url_for('rss_manager.edit_feed', feed_id=feed.id) }}" class="text-blue-500 hover:text-blue-700" title="Edit this feed">Edit</a>
                            <form action="{{ url_for('rss_manager.delete_rss_feed', feed_id=feed.id) }}" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to delete this feed?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="text-red-500 hover:text-red-700 ml-2">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Single Feed and Import Feeds from CSV Forms -->
    <div class="flex space-x-4 mb-8">
        <!-- Add Single Feed Form -->
        <div class="flex-1 p-6 bg-white shadow-md rounded-lg">
            <h2 class="text-xl font-bold mb-4">Add Single Feed</h2>
            <form id="addSingleFeedForm" onsubmit="return addFeed(event);">
                {{ form.hidden_tag() }}
                <div class="mb-4">
                    {{ form.url.label(class="block text-gray-700 text-sm font-bold mb-2") }}
                    {{ form.url(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline") }}
                </div>
                <div class="mb-4">
                    {{ form.category.label(class="block text-gray-700 text-sm font-bold mb-2") }}
                    {{ form.category(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline") }}
                </div>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Add Feed
                </button>
            </form>
        </div>

        <!-- Import Feeds from CSV Form -->
        <div class="flex-1 p-6 bg-white shadow-md rounded-lg">
            <h2 class="text-xl font-bold mb-4">Import Feeds from CSV</h2>
            <form method="POST" enctype="multipart/form-data">
                {{ csv_form.hidden_tag() }}
                <div class="mb-4">
                    {{ csv_form.file.label(class="block text-gray-700 text-sm font-bold mb-2") }}
                    {{ csv_form.file(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline") }}
                </div>
                {{ csv_form.submit(class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline") }}
            </form>
            <div class="mt-4">
                <a href="{{ url_for('static', filename='import_template.csv') }}" class="text-blue-500 hover:text-blue-700">
                    Download CSV Template
                </a>
            </div>
        </div>
    </div>

    <h2 class="text-2xl font-bold mb-4">Awesome Threat Intel Blogs</h2>
    <div class="mb-4 flex space-x-4">
        <form action="{{ url_for('rss_manager.update_awesome_threat_intel') }}" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to update Awesome Threat Intel Blogs?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">
                Update Awesome Threat Intel Blogs
            </button>
        </form>
    </div>
    <div id="awesomeBlogsContainer" class="p-6 bg-white shadow-md rounded-lg">
        <div class="mb-4">
            <label for="blogSearch" class="sr-only">Search blogs</label>
            <input type="text" id="blogSearch" placeholder="Search blogs..." class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            <label for="categoryFilter" class="sr-only">Filter by category</label>
            <select id="categoryFilter" class="mt-2 shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" aria-label="Filter by category">
                <option value="">All Categories</option>
                {% for category in categories %}
                    <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
            </select>
            <label for="typeFilter" class="sr-only">Filter by type</label>
            <select id="typeFilter" class="mt-2 shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" aria-label="Filter by type">
                <option value="">All Types</option>
                {% for type in types %}
                    <option value="{{ type }}">{{ type }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="py-2 px-4 border-b">Blog</th>
                        <th class="py-2 px-4 border-b">Category</th>
                        <th class="py-2 px-4 border-b">Type</th>
                        <th class="py-2 px-4 border-b">Blog Link</th>
                        <th class="py-2 px-4 border-b">Feed Link</th>
                        <th class="py-2 px-4 border-b">Actions</th>
                    </tr>
                </thead>
                <tbody id="awesomeBlogsList">
                {% for blog in awesome_blogs %}
                    <tr class="blog-item" data-category="{{ blog.blog_category }}" data-type="{{ blog.type }}">
                        <td class="py-2 px-4 border-b">{{ blog.blog }}</td>
                        <td class="py-2 px-4 border-b">{{ blog.blog_category }}</td>
                        <td class="py-2 px-4 border-b">{{ blog.type }}</td>
                        <td class="py-2 px-4 border-b"><a href="{{ blog.blog_link }}" target="_blank" class="text-blue-500 hover:text-blue-700 break-all">Blog Link</a></td>
                        <td class="py-2 px-4 border-b">
                            {% if blog.feed_link %}
                                <a href="{{ blog.feed_link }}" target="_blank" class="text-blue-500 hover:text-blue-700 break-all">Feed Link</a>
                            {% else %}
                                <p class="text-sm text-gray-500">No RSS feed available</p>
                            {% endif %}
                        </td>
                        <td class="py-2 px-4 border-b">
                            {% if blog.feed_link %}
                                {% if blog.is_in_rss_feeds %}
                                    <p class="text-sm text-green-500 font-bold">Already in RSS Feeds</p>
                                {% else %}
                                    <button onclick="addAwesomeFeed('{{ blog.id|string }}')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline add-feed-btn">
                                        Add Feed
                                    </button>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        async function addFeed(event) {
            event.preventDefault();
            const form = document.getElementById('addSingleFeedForm');
            const formData = new FormData(form);
            const data = {
                url: formData.get('url'),
                category: formData.get('category')
            };

            try {
                const response = await fetch('{{ url_for("rss_manager.create_rss_feed") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (response.ok) {
                    form.reset();
                    updateFeedsList(result.feeds);
                    showNotification('Feed added successfully', 'success');
                } else {
                    showNotification('Error adding feed: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('An unexpected error occurred while adding the feed. Please try again.', 'error');
            }
        }

        async function addAwesomeFeed(blogId) {
            try {
                const response = await fetch('{{ url_for("rss_manager.add_awesome_feed") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ blog_id: blogId })
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('Awesome feed added successfully', 'success');
                    updateFeedsList(result.feeds);
                    // Update the button to show it's already added
                    const addButton = document.querySelector(`button[onclick="addAwesomeFeed('${blogId}')"]`);
                    if (addButton) {
                        addButton.parentNode.innerHTML = '<p class="text-sm text-green-500 font-bold">Already in RSS Feeds</p>';
                    }
                    // Refresh the awesome blogs list to reflect the changes
                    await fetchAndPopulateAwesomeBlogs();
                } else {
                    showNotification('Error adding awesome feed: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error adding awesome feed:', error);
                showNotification('An unexpected error occurred while adding the awesome feed', 'error');
            }
        }

        function updateFeedsList(feeds) {
            const feedsTableBody = document.querySelector('tbody');
            feedsTableBody.innerHTML = '';
            feeds.forEach(feed => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2 px-4 border-b">${feed.url}</td>
                    <td class="py-2 px-4 border-b">${feed.category}</td>
                    <td class="py-2 px-4 border-b">
                        <a href="{{ url_for('rss_manager.edit_feed', feed_id='${feed.id}') }}" class="text-blue-500 hover:text-blue-700">Edit</a>
                        <button onclick="deleteFeed('${feed.id}')" class="text-red-500 hover:text-red-700 ml-2">Delete</button>
                    </td>
                `;
                feedsTableBody.appendChild(row);
            });
        }

        async function deleteFeed(feedId) {
            if (confirm('Are you sure you want to delete this feed?')) {
                try {
                    const response = await fetch(`{{ url_for('rss_manager.delete_rss_feed', feed_id='') }}${feedId}`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token() }}'
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        updateFeedsList(result.feeds);
                        showNot
{% endblock %}
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.className = `fixed top-4 right-4 p-4 rounded-md ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const blogSearch = document.getElementById('blogSearch');
            const categoryFilter = document.getElementById('categoryFilter');
            const typeFilter = document.getElementById('typeFilter');
            const awesomeBlogsList = document.getElementById('awesomeBlogsList');

            function filterBlogs() {
                const searchTerm = blogSearch.value.toLowerCase();
                const selectedCategory = categoryFilter.value;
                const selectedType = typeFilter.value;

                const blogItems = document.querySelectorAll('.blog-item');
                blogItems.forEach(item => {
                    const title = item.querySelector('h3').textContent.toLowerCase();
                    const category = item.dataset.category;
                    const type = item.dataset.type;

                    const matchesSearch = title.includes(searchTerm);
                    const matchesCategory = selectedCategory === "" || category === selectedCategory;
                    const matchesType = selectedType === "" || type === selectedType;

                    item.style.display = (matchesSearch && matchesCategory && matchesType) ? '' : 'none';
                });
            }

            function populateBlogs(blogs) {
                awesomeBlogsList.innerHTML = '';
                blogs.forEach(blog => {
                    const blogItem = document.createElement('div');
                    blogItem.classList.add('blog-item', 'bg-white', 'shadow-md', 'rounded', 'px-6', 'py-4', 'flex', 'flex-col', 'h-full', 'items-center', 'text-center');
                    blogItem.dataset.category = blog.blog_category;
                    blogItem.dataset.type = blog.type;

                    blogItem.innerHTML = `
                        <div class="flex-grow flex flex-col items-center justify-center">
                            <h3 class="text-lg font-semibold mb-2">${blog.blog}</h3>
                            <p class="text-sm text-gray-600 mb-2">Category: ${blog.blog_category}</p>
                            <p class="text-sm text-gray-500 mb-2">Type: ${blog.type}</p>
                            <a href="${blog.blog_link}" target="_blank" class="text-blue-500 hover:text-blue-700 break-all">Blog Link</a>
                            ${blog.feed_link ? `
                                <p class="text-sm text-gray-500 mt-2">Feed Type: RSS</p>
                                <a href="${blog.feed_link}" target="_blank" class="text-blue-500 hover:text-blue-700 break-all">Feed Link</a>
                            ` : '<p class="text-sm text-gray-500 mt-2">Feed Type: None</p>'}
                        </div>
                        <div class="mt-4 w-full">
                            ${blog.feed_link ? `
                                ${blog.is_in_rss_feeds ? `
                                    <p class="text-sm text-green-500 font-bold">Already in RSS Feeds</p>
                                ` : `
                                    <button onclick="addAwesomeFeed('${blog.id}')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline add-feed-btn">
                                        Add Feed
                                    </button>
                                `}
                            ` : `
                                <p class="text-sm text-gray-500">No RSS feed available</p>
                            `}
                        </div>
                    `;
                    awesomeBlogsList.appendChild(blogItem);
                });
            }

            async function fetchAndPopulateAwesomeBlogs() {
                try {
                    const response = await fetch('{{ url_for("rss_manager.get_awesome_blogs") }}');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    populateBlogs(data);
                    filterBlogs();
                } catch (error) {
                    console.error('Error fetching awesome blogs:', error);
                    showNotification('Error fetching awesome blogs', 'error');
                }
            }

            blogSearch.addEventListener('input', filterBlogs);
            categoryFilter.addEventListener('change', filterBlogs);
            typeFilter.addEventListener('change', filterBlogs);

            // Initial fetch of awesome blogs
            fetchAndPopulateAwesomeBlogs();
            await fetchAndPopulateAwesomeBlogs();
        });

        // Call fetchAndPopulateAwesomeBlogs when the page loads
        document.addEventListener('DOMContentLoaded', fetchAndPopulateAwesomeBlogs);
    </script>
