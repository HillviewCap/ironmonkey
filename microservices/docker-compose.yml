version: '3.8'

services:
  flask_frontend:
    build:
      context: ..
      dockerfile: Dockerfile
    ports:
      - "8181:8181"
    volumes:
      - ../app:/app
      - ../app/instance:/app/instance
    environment:
      - FLASK_ENV=production
    depends_on:
      - mongodb
      - neo4j
      - weaviate
    restart: always

  weaviate:
    command:
      - --host
      - 0.0.0.0
      - --port
      - "6578"
      - --scheme
      - http
    image: cr.weaviate.io/semitechnologies/weaviate:1.26.5
    ports:
      - 6578:6578
      - 50051:50051
    volumes:
      - weaviate_data:/var/lib/weaviate
    restart: on-failure
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"
      PERSISTENCE_DATA_PATH: "/var/lib/weaviate"
      DEFAULT_VECTORIZER_MODULE: "none"
      ENABLE_MODULES: ""
      CLUSTER_HOSTNAME: "node1"

  neo4j:
    image: neo4j:latest
    volumes:
      - ./neo4j/logs:/logs
      - ./neo4j/config:/config
      - ./neo4j/data:/data
      - ./neo4j/plugins:/plugins
    environment:
      - NEO4J_AUTH_FILE=/run/secrets/neo4j_auth_file
    ports:
      - "7474:7474"
      - "7687:7687"
    restart: always
    secrets:
      - neo4j_auth_file

  mongodb:
    image: mongo:6.0
    environment:
      - MONGO_INITDB_ROOT_USERNAME=ironmonkey
      - MONGO_INITDB_ROOT_PASSWORD=ironmonkey
      - MONGO_INITDB_DATABASE=threats_db
    volumes:
      - ./mongodb_data:/data/db
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    ports:
      - "27017:27017"
    restart: always
    command: ["mongod", "--auth"]

  sync_service:
    build:
      context: ./sync_service
      dockerfile: Dockerfile
    volumes:
      - ./sync_service:/app
    depends_on:
      - mongodb
    environment:
      - MONGO_INITDB_ROOT_USERNAME=ironmonkey
      - MONGO_INITDB_ROOT_PASSWORD=ironmonkey
      - MONGO_DATABASE=threats_db
    restart: always

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ./ollama_models:/root/.ollama/models
    command: /bin/bash -c "/ollama_models/run_ollama.sh"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["all"]
              capabilities: [gpu]
    healthcheck:
      test: ollama --version || exit 1
    restart: always

  dozzle:
    image: amir20/dozzle:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 8080:8080

volumes:
  weaviate_data:
  mongodb_data:
  ollama_models:

secrets:
  neo4j_auth_file:
    file: ./neo4j_auth.txt
  mongodb_auth:
    file: ./mongodb_auth.txt
