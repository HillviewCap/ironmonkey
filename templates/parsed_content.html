{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4">
    <h1 class="text-2xl font-bold mb-4">Parsed Content</h1>
    
    <div class="mb-4 flex justify-between items-center">
        <form action="{{ url_for('rss_manager.parsed_content') }}" method="get" class="flex items-center">
            <input type="text" name="search" value="{{ search_query }}" placeholder="Search..." class="border rounded-l px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-r hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Search</button>
        </form>
        <button id="clear-summaries-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500">Clear All Summaries</button>
    </div>
    
    {% if search_query %}
    <div class="mb-4">
        <p>Found {{ total_results }} result{% if total_results != 1 %}s{% endif %} for "{{ search_query }}"</p>
    </div>
    {% endif %}

    <div id="parsed-content-table"></div>

    <script src="{{ url_for('static', filename='js/node_modules/gridjs/dist/gridjs.umd.js') }}"></script>
    <link href="{{ url_for('static', filename='js/node_modules/gridjs/dist/theme/mermaid.min.css') }}" rel="stylesheet" />

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const grid = new gridjs.Grid({
            columns: [
                { 
                    id: 'title', 
                    name: 'Title',
                    formatter: (cell, row) => gridjs.html(`<a href="/view/${row.cells[4].data}" class="text-blue-500 hover:underline">${cell}</a>`)
                },
                { 
                    id: 'summary', 
                    name: 'Summary', 
                    width: '300px',
                    formatter: (cell) => cell && cell.length > 500 ? cell.substring(0, 500) + '...' : cell
                },
                { 
                    id: 'url', 
                    name: 'URL',
                    formatter: (cell) => {
                        if (!cell) return '';
                        const truncatedCell = cell.length > 500 ? cell.substring(0, 500) + '...' : cell;
                        return gridjs.html(`<a href="${cell}" target="_blank" class="text-blue-500 hover:underline" title="${cell}">Source</a>`);
                    },
                    width: '100px'
                },
                { 
                    id: 'pub_date', 
                    name: 'Published Date',
                    formatter: (cell) => gridjs.html(`<span class="text-sm">${cell}</span>`)
                },
                {
                    id: 'actions',
                    name: 'Actions',
                    formatter: (_, row) => gridjs.html(`
                        <button class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-2 rounded summarize-btn" data-post-id="${row.cells[4].data}">
                            Summarize
                        </button>
                    `),
                    width: '100px'
                }
            ],
            server: {
                url: '{{ url_for("rss_manager.parsed_content_data") }}',
                then: data => data.data.map(post => [
                    post.title || '',
                    post.summary || '',
                    post.url || '',
                    post.pub_date || '',
                    post.id || ''
                ]),
                total: data => data.total
            },
            search: true,
            sort: true,
            pagination: {
                limit: 10,
                server: {
                    url: (prev, page, limit) => `${prev}${prev.includes('?') ? '&' : '?'}page=${page}&limit=${limit}`
                }
            }
        }).render(document.getElementById("parsed-content-table"));

        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('summarize-btn')) {
                event.stopPropagation();
                const postId = event.target.getAttribute('data-post-id');
                summarizeContent(postId);
            }
        });

        function tagContent(postId) {
            fetch('/tag_content', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ content_id: postId })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                grid.forceRender();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while tagging the content.');
            });
        }

        function summarizeContent(postId) {
            const button = document.querySelector(`button[data-post-id="${postId}"]`);
            if (button.disabled) return; // Prevent multiple clicks

            const originalText = button.textContent;
            button.textContent = 'Summarizing...';
            button.disabled = true;

            fetch('{{ url_for("summarize_content") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ content_id: postId })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.summary) {
                    alert('Content summarized successfully!');
                    grid.forceRender();
                } else {
                    throw new Error(data.error || 'Failed to summarize content');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while summarizing the content: ' + (error.error || error.message));
            })
            .finally(() => {
                button.textContent = originalText;
                button.disabled = false;
            });
        }

        const clearSummariesBtn = document.getElementById('clear-summaries-btn');
        clearSummariesBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all summaries? This action cannot be undone.')) {
                fetch('/clear_all_summaries', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    grid.forceRender();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while processing your request.');
                });
            }
        });
    });
    </script>
</div>
{% endblock %}
