{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4">
    <h1 class="text-2xl font-bold mb-4">Parsed Content</h1>
    
    <div class="mb-4 flex justify-between items-center">
        <form action="{{ url_for('rss_manager.parsed_content') }}" method="get" class="flex items-center">
            <input type="text" name="search" value="{{ search_query }}" placeholder="Search..." class="border rounded-l px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-r hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Search</button>
        </form>
        <button id="clear-summaries-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500">Clear All Summaries</button>
    </div>

    <div class="overflow-x-auto max-w-full">
        <table class="w-full table-auto">
            <thead>
                <tr class="bg-gray-200">
                    <th class="px-2 py-2">Title</th>
                    <th class="px-2 py-2">URL</th>
                    <th class="px-2 py-2">Published Date</th>
                    <th class="px-2 py-2">Summary</th>
                    <th class="px-2 py-2">Tag Actions</th>
                    <th class="px-2 py-2">Summarize Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for post in posts %}
                <tr class="{% if loop.index % 2 == 0 %}bg-gray-100{% endif %}">
                    <td class="border px-2 py-2 break-words">
                        <a href="{{ url_for('view_item', item_id=post.id) }}" class="text-blue-600 hover:underline">
                            {{ post.title[:50] }}
                        </a>
                    </td>
                    <td class="border px-2 py-2 break-words">
                        <a href="{{ post.url }}" class="text-blue-500 hover:underline" target="_blank">
                            {{ post.url[:50] }}
                        </a>
                    </td>
                    <td class="border px-2 py-2">{{ post.pub_date }}</td>
                    <td class="border px-2 py-2 break-words">
                        <span class="summary-content">{{ post.summary[:50] if post.summary else 'No summary' }}</span>
                    </td>
                    <td class="border px-2 py-2">
                        <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded tag-content-btn" data-post-id="{{ post.id }}">
                            Tag Content
                        </button>
                    </td>
                    <td class="border px-2 py-2">
                        <button class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-2 rounded summarize-btn" data-post-id="{{ post.id }}">
                            Summarize
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="mt-4 flex justify-center">
        {% if pagination.has_prev %}
            <a href="{{ url_for('rss_manager.parsed_content', page=pagination.prev_num, search=search_query) }}" class="px-3 py-2 bg-blue-500 text-white rounded mr-2 hover:bg-blue-600">&laquo; Previous</a>
        {% endif %}
        
        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
                {% if page_num != pagination.page %}
                    <a href="{{ url_for('rss_manager.parsed_content', page=page_num, search=search_query) }}" class="px-3 py-2 bg-gray-200 text-gray-700 rounded mr-2 hover:bg-gray-300">{{ page_num }}</a>
                {% else %}
                    <span class="px-3 py-2 bg-blue-500 text-white rounded mr-2">{{ page_num }}</span>
                {% endif %}
            {% else %}
                <span class="px-3 py-2">...</span>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
            <a href="{{ url_for('rss_manager.parsed_content', page=pagination.next_num, search=search_query) }}" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Next &raquo;</a>
        {% endif %}
    </div>
</div>

<style>
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 10px;
        vertical-align: middle;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const clearSummariesBtn = document.getElementById('clear-summaries-btn');
    clearSummariesBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to clear all summaries? This action cannot be undone.')) {
            fetch('/clear_all_summaries', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while processing your request.');
            });
        }
    });

    const tagButtons = document.querySelectorAll('.tag-content-btn');
    tagButtons.forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            fetch('/tag_content', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ content_id: postId })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while tagging the content.');
            });
        });
    });

    const summarizeButtons = document.querySelectorAll('.summarize-btn');
    summarizeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            const summaryElement = this.closest('tr').querySelector('.summary-content');
            const existingSummary = summaryElement.textContent.trim();

            if (existingSummary !== 'No summary') {
                if (!confirm('An existing summary is present. Do you want to overwrite it?')) {
                    return;
                }
            }

            // Disable the button and show loading spinner
            this.disabled = true;
            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            this.parentNode.insertBefore(spinner, this.nextSibling);

            fetch('/summarize_content', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ content_id: postId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.summary) {
                    summaryElement.textContent = data.summary.substring(0, 50) + (data.summary.length > 50 ? '...' : '');
                } else {
                    console.error('Failed to generate summary.');
                    alert('Failed to generate summary. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while generating the summary. Please try again.');
                summaryElement.textContent = 'Error generating summary';
            })
            .finally(() => {
                // Re-enable the button and remove the spinner
                this.disabled = false;
                spinner.remove();
            });
        });
    });
});
</script>
{% endblock %}
